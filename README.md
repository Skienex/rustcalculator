Mostly written by @sqyyy-jar.
